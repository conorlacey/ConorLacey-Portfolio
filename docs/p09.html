<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Portfolio 9</title>

<script src="site_libs/header-attrs-2.20/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Portfolio</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="p01.html">Portfolio 1</a>
</li>
<li>
  <a href="p02.html">Portfolio 2</a>
</li>
<li>
  <a href="p03.html">Portfolio 3</a>
</li>
<li>
  <a href="p04.html">Portfolio 4</a>
</li>
<li>
  <a href="p05.html">Portfolio 5</a>
</li>
<li>
  <a href="p06.html">Portfolio 6</a>
</li>
<li>
  <a href="p07.html">Portfolio 7</a>
</li>
<li>
  <a href="p08.html">Portfolio 8</a>
</li>
<li>
  <a href="p09.html">Portfolio 9</a>
</li>
<li>
  <a href="p10.html">Portfolio 10</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Portfolio 9</h1>

</div>


<pre class="r"><code>suppressWarnings(library(tidyverse))</code></pre>
<pre><code>## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
## ✔ dplyr     1.1.0     ✔ readr     2.1.4
## ✔ forcats   1.0.0     ✔ stringr   1.5.0
## ✔ ggplot2   3.4.1     ✔ tibble    3.2.1
## ✔ lubridate 1.9.2     ✔ tidyr     1.3.0
## ✔ purrr     1.0.1     
## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
## ℹ Use the ]8;;http://conflicted.r-lib.org/conflicted package]8;; to force all conflicts to become errors</code></pre>
<pre class="r"><code>suppressWarnings(suppressMessages(library(rvest)))
suppressWarnings(library(stringi))
suppressWarnings(library(glue))
suppressWarnings(library(robotstxt))</code></pre>
<div id="introduction" class="section level3">
<h3>Introduction</h3>
<p>Ok so I need to buy a new car so I’m going to scrape some data from
carvana! Specifically I’m looking for a subaru so I will get the link to
that specific search space from the website. <a
href="https://www.carvana.com/cars/subaru?email-capture=&amp;page=1"
class="uri">https://www.carvana.com/cars/subaru?email-capture=&amp;page=1</a></p>
</div>
<div id="make-urls" class="section level3">
<h3>Make Urls</h3>
<p>First I need to write a function to scrape one page.</p>
<pre class="r"><code>url &lt;- &quot;https://www.carvana.com/cars/subaru?email-capture=&amp;page=1&quot;

scrape_page &lt;- function(url) {

page &lt;- read_html(url)

#Title and year
cars &lt;- page %&gt;% 
  html_nodes(&quot;.year-make&quot;) %&gt;% 
  html_text()

year &lt;- substring(cars,1,4) %&gt;% as.numeric()

car &lt;- substring(cars, 6, nchar(cars))

#Monthly 
page %&gt;% 
  html_nodes(&quot;.middle-frame&quot;) %&gt;% 
  html_text()

#Cost 
cost &lt;- page %&gt;% 
  html_nodes(&quot;.text-2xl&quot;) %&gt;% 
  html_text()

#Miles 
miles &lt;- page %&gt;% 
  html_nodes(&quot;.trim-mileage&quot;) %&gt;% 
  html_text()

data.frame(car = car, year = year, cost = cost, miles = miles)
}

head(scrape_page(url))</code></pre>
<pre><code>##                car year    cost                          miles
## 1    Subaru Legacy 2020 $23,590            base • 28,707 miles
## 2 Subaru Crosstrek 2022 $30,590             base • 3,710 miles
## 3       Subaru BRZ 2019 $32,990          Limited • 5,000 miles
## 4    Subaru Legacy 2016 $20,990            2.5i • 39,498 miles
## 5       Subaru WRX 2017 $32,990 WRX STI Limited • 42,585 miles
## 6  Subaru Forester 2016 $19,590            2.5i • 67,345 miles</code></pre>
</div>
<div id="scrape-multiple-urls" class="section level3">
<h3>Scrape Multiple URLS</h3>
<p>Ok now we have a function that will scrape a page. However, now let’s
scrape all 46.</p>
<pre class="46"><code>root &lt;- &quot;https://www.carvana.com/cars/subaru?email-capture=&amp;page=&quot;
numbers &lt;- seq(from = 1, to = 46, by = 1)
urls &lt;- glue(&quot;{root}{numbers}&quot;)

cars.df &lt;- map_dfr(urls,scrape_page) #This will bind the data from each page</code></pre>
<p>Uh oh? Houston we have a problem. If you look up this error “HTTP
error 429”, you will find we are having issues with being rate limited.
Rate limiting is preventing our bot from operating as it is exceeding
some constraint. The constraint is network traffic or in other words we
are going through too many pages at a time on Carvana’s website.</p>
</div>
<div id="scrape-one-at-a-time" class="section level3">
<h3>Scrape One At a Time</h3>
<p>There a few ways to solve this and perhaps the most efficient way
would be to make an API request of their car inventory. However, they
unfortunately do not make this available so we will go with the waiting
around approach. What i mean by this is we can simply just pause the
programming until the rate limit resets. I suspect this one takes about
15 minutes and I also suspect it’ll begin to rate limit after scrapping
about 20 pages.</p>
<p>Therefore, we shall write a program that scrapes 20 pages at a time
and will pause for 15 minutes after scraping 20 pages to allow for the
rate limit to reset. This may seem inefficient, but we are only wanting
46 pages and personally this is fine by me if I wait about 30 minutes.
I’ll just answer some emails while this runs.</p>
<pre class="one"><code>numbers1 &lt;- seq(from = 1, to = 10, by = 1)
numbers2 &lt;- seq(from = 11, to = 20, by = 1)
numbers3 &lt;- seq(from = 21, to = 30, by = 1)
numbers4 &lt;- seq(from = 31, to = 40, by = 1)
numbers5 &lt;- seq(from = 41, to = 46, by = 1)

urls1 &lt;- glue(&quot;{root}{numbers1}&quot;)
urls2 &lt;- glue(&quot;{root}{numbers2}&quot;)
urls3 &lt;- glue(&quot;{root}{numbers3}&quot;)
urls4 &lt;- glue(&quot;{root}{numbers4}&quot;)
urls5 &lt;- glue(&quot;{root}{numbers5}&quot;)

cars.df.1 &lt;- map_dfr(urls1,scrape_page)
cars.df.2 &lt;- map_dfr(urls2,scrape_page)
Sys.sleep(15*60) #This will pause the programming for 15 minutes
cars.df.3&lt;- map_dfr(urls3,scrape_page)
cars.df.4 &lt;- map_dfr(urls4,scrape_page)
Sys.sleep(15*60) #This will pause the programming for 15 minutes
cars.df.5 &lt;- map_dfr(urls5,scrape_page)

#Bind the data 
cars.df &lt;- bind_rows(cars.df.1, 
                     cars.df.2,
                     cars.df.3,
                     cars.df.4,
                     cars.df.5)
#Save the data file
write_rds(cars.df, &quot;cars.RDS&quot;)</code></pre>
</div>
<div id="final-edits" class="section level3">
<h3>Final Edits</h3>
<p>Ok now we have a our data. However, the data frame still needs some
editing. Specifically the miles column.</p>
<pre class="r"><code>cars.df &lt;- read_rds(&quot;cars.RDS&quot;)
head(cars.df)</code></pre>
<pre><code>##                car year    cost                       miles
## 1 Subaru Crosstrek 2016 $23,990 2.0i Limited • 51,811 miles
## 2   Subaru Impreza 2021 $21,990         base • 12,011 miles
## 3 Subaru Crosstrek 2019 $28,990 2.0i Limited • 23,356 miles
## 4  Subaru Forester 2017 $22,990 2.5i Limited • 78,471 miles
## 5   Subaru Outback 2018 $21,590 2.5i Premium • 95,221 miles
## 6       Subaru WRX 2019 $29,590  WRX Premium • 32,051 miles</code></pre>
<p>I don’t want the entire string, I just want to extract the actual
miles on the vehicle. To do this we will include all characters beyond
“•”.</p>
<pre class="r"><code>cars.df$miles &lt;- cars.df$miles %&gt;% 
  str_sub(str_locate(cars.df$miles, &quot;•&quot;)[,1]+2)

head(cars.df)</code></pre>
<pre><code>##                car year    cost        miles
## 1 Subaru Crosstrek 2016 $23,990 51,811 miles
## 2   Subaru Impreza 2021 $21,990 12,011 miles
## 3 Subaru Crosstrek 2019 $28,990 23,356 miles
## 4  Subaru Forester 2017 $22,990 78,471 miles
## 5   Subaru Outback 2018 $21,590 95,221 miles
## 6       Subaru WRX 2019 $29,590 32,051 miles</code></pre>
<p>Perfect now let’s get rid of all the characters I do not want and
make this column numeric.</p>
<p>We shall do the same thing for column cost.</p>
<pre class="r"><code>cars.df$miles &lt;- cars.df$miles %&gt;% 
  str_replace(&quot;,&quot;, &quot;&quot;) %&gt;% 
  str_replace(&quot; miles&quot;, &quot;&quot;) %&gt;% 
  as.numeric()

cars.df$cost &lt;- cars.df$cost %&gt;% 
  str_sub(2,) %&gt;% 
  str_replace(&quot;,&quot;, &quot;&quot;) %&gt;% 
  as.numeric()

head(cars.df)</code></pre>
<pre><code>##                car year  cost miles
## 1 Subaru Crosstrek 2016 23990 51811
## 2   Subaru Impreza 2021 21990 12011
## 3 Subaru Crosstrek 2019 28990 23356
## 4  Subaru Forester 2017 22990 78471
## 5   Subaru Outback 2018 21590 95221
## 6       Subaru WRX 2019 29590 32051</code></pre>
<p>Perfect! Now I have my subaru data set!</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
